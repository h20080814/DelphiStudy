unit UnitThread;

interface

uses
  System.SysUtils, System.Classes;

type
  TRWFile = class
  end;

type
  TFileRWThread = class(TThread)
  private
    FRWFile: TRWFile;
  protected
    procedure Execute; override;
  public
    constructor create; overload;
    constructor create(FRWFile: TRWFile); overload;
  end;

implementation

uses
  UnitmainFrom;


{ TFileRWThread }

constructor TFileRWThread.create(FRWFile: TRWFile);
begin
  inherited create(False);
  Self.FRWFile := FRWFile;
end;

constructor TFileRWThread.create;
begin
  inherited create(True);
end;

procedure TFileRWThread.Execute;
var
  SourceFile, TargetFile: file;
  Buff: array[0..255] of Byte; //缓存：临时存放数据的空间
  Str: string;
begin

  System.TMonitor.Enter(Self.FRWFile);  //进入临界区
  try
  //关联变量
    AssignFile(SourceFile, Source_File);
    AssignFile(TargetFile, Target_File);
  //设置打开方式
    Reset(SourceFile);   //以读的方式打开
    Rewrite(TargetFile); //以写的方式打开
    Form1.pb1.Max := FileSize(SourceFile);
  //读写  边读边写
    while not Eof(SourceFile) do begin
      BlockRead(SourceFile, Buff, 1);  //读取1个字节的数据
      BlockWrite(TargetFile, Buff, 1); //写入1个字节
      Str := '线程ID ' + Self.ThreadID.ToString;
      Form1.mmo1.Lines.Add(Str);
      Form1.pb1.Position := FileSize(TargetFile);
    end;

  finally
  //关闭文件
    CloseFile(SourceFile);
    CloseFile(TargetFile);
  end;
  System.TMonitor.Exit(Self.FRWFile);
end;

end.

