unit UnitTool;

interface
 {
 在windows下，可以用系统提供的regsvr32工具注册和卸载COM组件：
  注册：regsvr32 文件名
  卸载：regsvr32 /u 文件名
 COM组件一般存在于动态链接库中，库文件扩展名为dll,ocx,ax(音频和视频的Filter)等。
 必须导出以下4个函数：
  function DLLGetClassObject(const CLSID,IID,TGUID;var Obj):HResult;stdcall;
  function DLLCanUnloadNow:HResult;stdcall;
  function DLLRegisterServer:HResult;stdcall;
  function DLLUnregisterServer:HResult;stdcall;
 }
uses
  System.Win.ComObj, Winapi.Windows, System.Classes, System.Variants, System.Win.StdVCL,
  Vcl.Graphics, Vcl.OleServer, Dm_TLB, Winapi.ActiveX;

function OLERegister(sOleFileName: string; OleAction: Byte): Boolean;

implementation

function OLERegister(sOleFileName: string; OleAction: Byte): Boolean;
const
  RegisterOle = 1;  //注册
  UnRegisterOle = 0;  //卸载
type
  TOleRegisterFunction = function: HRESULT;  //注册或卸载函数原型
var
  hLibraryHadle: THandle;  //由LoadLibray返回的DLL或ocx句柄
  hFunctionAddress: TFarProc;  //DLL或ocx中的函数句柄，由GetProAddress返回
  RegFunction: TOleRegisterFunction;  //注册或卸载函数指针
begin
  Result := False;
  //打开文件，返回DLL或ocx句柄
  hLibraryHadle := LoadLibrary(PChar(sOleFileName));
  if (hLibraryHadle > 0) then  //DLLakg OCX句柄正确
  try
  //返回注册或卸载函数指针
    if (OleAction = RegisterOle) then  //返回注册函数指针
    begin
      hFunctionAddress := GetProcAddress(hLibraryHadle, PAnsiChar('DLLRegisterSever'));
    end
    else
    begin
      hFunctionAddress := GetProcAddress(hLibraryHadle, PAnsiChar('DLLUnRegisterSever'));
    end;
    if (hFunctionAddress <> nil) then begin  //判断注册或卸载函数是否存在
      RegFunction := TOleRegisterFunction(hFunctionAddress); //获得操作函数的指针
      if RegFunction >= 0 then begin  //执行注册或卸载操作，返回值>=0表示成功
        Result := True;
      end;
    end;
  finally
    FreeLibrary(hLibraryHadle);  //关闭已打开的文件

  end;

end;

end.

